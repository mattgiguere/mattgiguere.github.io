<!DOCTYPE html>
<html>
<style type="text/css">
  code.has-jax {
    font: inherit; font-size: 100%; background: inherit; border: inherit;
  }
</style>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Setting up Python and MPI on EC2</title>
  <meta name="description" content="In a previous post, I described how to setup a cluster using the Amazon EC2 service and the starcluster package. In this post I will describe getting Python ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://mattgiguere.github.io/2015/03/26/setting-up-python-on-ec2.html">
  <link rel="alternate" type="application/rss+xml" title="Matt Giguere" href="http://mattgiguere.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Matt Giguere</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/testing/">Testing</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Setting up Python and MPI on EC2</h1>
    <p class="post-meta">Mar 26, 2015</p>
  </header>

  <article class="post-content">
    <p>In a <a href="/2015/03/11/creating-an-aws-ec2-cluster.html">previous post</a>, I described how to setup a cluster using the Amazon EC2 service and the starcluster package. In this post I will describe getting Python and MPI up and running on a <a href="http://star.mit.edu/cluster">Starcluster</a> cluster instance on Amazon EC2.</p>

<h4 id="starting-up-the-cluster">Starting up the cluster</h4>

<p>First, we need to start our cluster instance. This can easily be done using starcluster by typing the following command:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">starcluster start mycluster</code></pre></div>

<p>To SSH into the master node of the cluster:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">starcluster sshmaster mycluster</code></pre></div>

<p>The SSH port on my machine is different from the default port, and it caused some problems with starcluster.</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">starcluster sshmaster mycluster
StarCluster - <span class="o">(</span>http://star.mit.edu/cluster<span class="o">)</span> <span class="o">(</span>v. 0.95.6<span class="o">)</span>
Software Tools <span class="k">for</span> Academics and Researchers <span class="o">(</span>STAR<span class="o">)</span>
Please submit bug reports to starcluster@mit.edu

ssh: connect to host ec2-25-3-89-123.compute-1.amazonaws.com port 2234: Operation timed out</code></pre></div>

<p>One solution to this is to add an entry in <code>~/.ssh/config</code> to specify the port to the master node:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">Host ec2-25-3-89-123.compute-1.amazonaws.com
   Hostname ec2-25-3-89-123.compute-1.amazonaws.com
   Port 22</code></pre></div>

<p>But this means adding a new entry every time a new cluster is started! That’s not an acceptable solution.</p>

<p>I ended up changing the SSH port in <code>/etc/services</code> <em>back</em> to 22, and then modifying the <code>/System/Library/LaunchDaemons/ssh.plist</code> file to a port other than 22.</p>

<p>Here’s what that looks like in OS X Yosemite:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;
&lt;!DOCTYPE plist PUBLIC <span class="s2">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="s2">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;
&lt;plist <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>&gt;
&lt;dict&gt;
	&lt;key&gt;Disabled&lt;/key&gt;
	&lt;<span class="nb">true</span>/&gt;
	&lt;key&gt;Label&lt;/key&gt;
	&lt;string&gt;com.openssh.sshd&lt;/string&gt;
	&lt;key&gt;Program&lt;/key&gt;
	&lt;string&gt;/usr/libexec/sshd-keygen-wrapper&lt;/string&gt;
	&lt;key&gt;ProgramArguments&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;/usr/sbin/sshd&lt;/string&gt;
		&lt;string&gt;-i&lt;/string&gt;
	&lt;/array&gt;
	&lt;key&gt;Sockets&lt;/key&gt;
	&lt;dict&gt;
		&lt;key&gt;Listeners&lt;/key&gt;
		&lt;dict&gt;
			&lt;key&gt;SockServiceName&lt;/key&gt;
			&lt;string&gt;2123&lt;/string&gt;
			&lt;key&gt;Bonjour&lt;/key&gt;
			&lt;array&gt;
				&lt;string&gt;ssh&lt;/string&gt;
				&lt;string&gt;2123&lt;/string&gt;
			&lt;/array&gt;
		&lt;/dict&gt;
	&lt;/dict&gt;
	&lt;key&gt;inetdCompatibility&lt;/key&gt;
	&lt;dict&gt;
		&lt;key&gt;Wait&lt;/key&gt;
		&lt;<span class="nb">false</span>/&gt;
	&lt;/dict&gt;
	&lt;key&gt;StandardErrorPath&lt;/key&gt;
	&lt;string&gt;/dev/null&lt;/string&gt;
	&lt;key&gt;SHAuthorizationRight&lt;/key&gt;
	&lt;string&gt;system.preferences&lt;/string&gt;
	&lt;key&gt;POSIXSpawnType&lt;/key&gt;
	&lt;string&gt;Interactive&lt;/string&gt;
&lt;/dict&gt;
&lt;/plist&gt;</code></pre></div>

<p>Changing the port number to 2123 in the ssh.plist makes it so that my computer only allows incoming connections to port 2123, but the default port when trying to connect to other machines is still 22. Perfect!</p>

<h4 id="setting-up-python">Setting up python</h4>

<p>Next, we want to get the proper version of python installed on our cluster. The instances that come with starcluster by default have a ton of useful tools already built in. Immediately after SSHing into the master node, the available tools are listed:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">starcluster sshmaster mycluster
StarCluster - <span class="o">(</span>http://star.mit.edu/cluster<span class="o">)</span> <span class="o">(</span>v. 0.95.6<span class="o">)</span>
Software Tools <span class="k">for</span> Academics and Researchers <span class="o">(</span>STAR<span class="o">)</span>
Please submit bug reports to starcluster@mit.edu

The authenticity of host <span class="s1">&#39;ec2-25-3-89-123.compute-1.amazonaws.com (25.3.89.123)&#39;</span> can<span class="s1">&#39;t be established.</span>
<span class="s1">RSA key fingerprint is ab:ef:d8:2f:3c:78:b3:a2:a2:2c:4d:8e:3f:7e:2a:8c.</span>
<span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
<span class="s1">Warning: Permanently added &#39;</span>ec2-25-3-89-123.compute-1.amazonaws.com,25.3.89.123<span class="s1">&#39; (RSA) to the list of known hosts.</span>
<span class="s1">          _                 _           _</span>
<span class="s1">__/\_____| |_ __ _ _ __ ___| |_   _ ___| |_ ___ _ __</span>
<span class="s1">\    / __| __/ _` | &#39;</span>__/ __<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> / __<span class="p">|</span> __/ _ <span class="se">\ </span><span class="s1">&#39;__|</span>
<span class="s1">/_  _\__ \ || (_| | | | (__| | |_| \__ \ ||  __/ |</span>
<span class="s1">  \/ |___/\__\__,_|_|  \___|_|\__,_|___/\__\___|_|</span>

<span class="s1">StarCluster Ubuntu 13.04 AMI</span>
<span class="s1">Software Tools for Academics and Researchers (STAR)</span>
<span class="s1">Homepage: http://star.mit.edu/cluster</span>
<span class="s1">Documentation: http://star.mit.edu/cluster/docs/latest</span>
<span class="s1">Code: https://github.com/jtriley/StarCluster</span>
<span class="s1">Mailing list: http://star.mit.edu/cluster/mailinglist.html</span>

<span class="s1">This AMI Contains:</span>

<span class="s1">  * NVIDIA Driver 331.38</span>
<span class="s1">  * NVIDIA CUDA Toolkit 5.5.22</span>
<span class="s1">  * PyCuda 2013.1.1 and PyOpenCL 2013.2</span>
<span class="s1">  * MAGMA 1.4.1</span>
<span class="s1">  * Intel Ethernet Driver 2.11.3 (ixgbevf)</span>
<span class="s1">  * Open Grid Scheduler (OGS - formerly SGE) queuing system</span>
<span class="s1">  * Condor workload management system</span>
<span class="s1">  * OpenMPI compiled with Open Grid Scheduler support</span>
<span class="s1">  * OpenBLAS - Highly optimized Basic Linear Algebra Routines</span>
<span class="s1">  * NumPy/SciPy linked against OpenBlas</span>
<span class="s1">  * Pandas - Data Analysis Library</span>
<span class="s1">  * IPython 1.1.0 with parallel and notebook support</span>
<span class="s1">  * Julia 0.3pre</span>
<span class="s1">  * and more! (use &#39;</span>dpkg -l<span class="err">&#39;</span> to show all installed packages<span class="o">)</span>

Open Grid Scheduler/Condor cheat sheet:

  * qstat/condor_q - show status of batch <span class="nb">jobs</span>
  * qhost/condor_status- show status of hosts, queues, and <span class="nb">jobs</span>
  * qsub/condor_submit - submit batch <span class="nb">jobs</span> <span class="o">(</span>e.g. qsub -cwd ./job.sh<span class="o">)</span>
  * qdel/condor_rm - delete batch <span class="nb">jobs</span> <span class="o">(</span>e.g. qdel 7<span class="o">)</span>
  * qconf - configure Open Grid Scheduler system

Current System Stats:

  System load:  0.0               Processes:           94
  Usage of /:   63.3% of 7.74GB   Users logged in:     0
  Memory usage: 11%               IP address <span class="k">for</span> eth0: 123.45.6.78
  Swap usage:   0%

    https://landscape.canonical.com/
root@master:~#</code></pre></div>

<p>This is really great, but a lot of the versions listed here are dated, and the APIs have changed considerably. One option is to upgrade some of these libraries with pip:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">pip install pandas --upgrade</code></pre></div>

<p>One down side is that it takes a little over 9 minutes to execute. If you’re willing to wait 9 minutes every time you start your cluster, then that is probably the best option for you. If not, another option is to use <a href="http://conda.pydata.org/miniconda.html">miniconda</a>, a lightweight package that only contains conda and python, and then install only the necessary dependencies. I used miniconda when setting up travis-ci, which was covered briefly in <a href="/2015/03/20/better-python-coding-practices.html">this post</a>.</p>

<p>For now, I’m fine with waiting 9 minutes to startup the cluster. I made a script that will start up the cluster, and copy over all of the code and input data I want to use. Here’s what that script looks like:</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Matt Giguere</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Matt Giguere</li>
          <li><a href="mailto:matthew.giguere@yale.edu">matthew.giguere@yale.edu</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mattgiguere">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">mattgiguere</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/magickair">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">magickair</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Hi, I'm Matt Giguere, a graduate student searching for rocky planets and characterizing stellar activity of the stars that host them. In addition to working towards the discovery  of other rocky worlds, I am constantly working to defend my best dad  of the year title. I also enjoy learning new programming languages,  new statistical methods, and new visualization tools, and making  things in many different media.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>
<!-- MathJax Section -->
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
</html>
