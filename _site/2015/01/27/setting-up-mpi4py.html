<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Setting up mpi4py</title>
  <meta name="description" content="Today I’ve been trying to get emcee up and running and to use it with MPI. There were a number of obstacles that I needed to overcome to get MPI working on m...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://mattgiguere.github.io/2015/01/27/setting-up-mpi4py.html">
  <link rel="alternate" type="application/rss+xml" title="Matt Giguere" href="http://mattgiguere.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Matt Giguere</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/about/">Testing</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Setting up mpi4py</h1>
    <p class="post-meta">Jan 27, 2015</p>
  </header>

  <article class="post-content">
    <p>Today I’ve been trying to get <code>emcee</code> up and running and to use it with MPI. There were a number of obstacles that I needed to overcome to get MPI working on multiple machines.</p>

<p>I have an anaconda installation of python, and mpi4py is one of the packages they support (more below), so I installed mpi4py using the following command:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">conda install mpi4py</code></pre></div>

<p>But when I tried running it I got the following error:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">/opt/anaconda1anaconda2anaconda3/share/openmpi/help-opal-runtime.txt</code></pre></div>

<p>Fortunately for me, <a href="https://groups.google.com/a/continuum.io/forum/#!topic/anaconda/7CsGQKNvcdQ">someone else encountered a similar error</a>. Until anaconda fixes their bug, an inelegant hack is to make a symbolic link pointing from /opt/ana… to the correct path. I have anaconda python installed for all users, so instead of pointing the symbolic link to my home directory, I pointed it to the directory containing the anaconda python distribution, the Applications directory:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">sudo ln -s /Applications/anaconda/ /opt/anaconda1anaconda2anaconda3</code></pre></div>

<p>I did this on all 5 machines that I plan on testing MPI on. The next step is to create a hostfile containing the names or IP addresses of all hosts that will be used for computing. This is just a simple text file containing nothing more than the name of the host and the number of slots, or threads, to run on it at any given time:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">host1.example.edu <span class="nv">slots</span><span class="o">=</span>12
host2.example.edu <span class="nv">slots</span><span class="o">=</span>8</code></pre></div>

<p>The example tests in the <a href="http://mpi4py.scipy.org/docs/usrman/install.html">mpi4py documentation</a> failed for me, but @jbornschein put together a nice <a href="https://github.com/jbornschein/mpi4py-examples">github repository with some example code</a>. I ran the 01-helloworld example, specifying the hosts I wanted to distribute the jobs to:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nb">cd </span>projects/mpi4pyexamples
mpirun --hostfile myhostfile.txt ./01-helloworld</code></pre></div>

<p>After a rather long delay in returning a result, an error was returned saying it could connect on the default port. That makes sense since we use non-default ports for our machines. After some searching, it doesn’t seem like there’s any way to specify the port in the hostfile, instead I used an ssh config file. I’m using Mac OS X 10.10, and setting a config file up was quite quick and easy to do:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">emacs ~/.ssh/config</code></pre></div>

<p>and for contents add</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">Host host1.example.edu
   Hostname host1.example.edu
   Port 2400

Host host2.example.edu
   Hostname host2.example.edu
   Port 2400</code></pre></div>

<p>After adding the hosts and ports to the <code>config</code> file, I didn’t need to restart, or open a new terminal window or anything else that might be expected. Reissuing the same command in the same terminal window returned an immediate result:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">∞ mpirun --hostfile myhostfile ./01-hello-world
Hello! I<span class="s1">&#39;m rank 1 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">3</span> from <span class="m">8</span> running in total...
Hello! I<span class="s1">&#39;m rank 0 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">2</span> from <span class="m">8</span> running in total...
Hello! I<span class="s1">&#39;m rank 7 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">4</span> from <span class="m">8</span> running in total...
Hello! I<span class="s1">&#39;m rank 5 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">6</span> from <span class="m">8</span> running in total...
^Cmpirun: killing job...</code></pre></div>

<p>However, as you can see things didn’t end very well. I had to kill the job, otherwise I end up with a strange error:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">∞ mpirun --hostfile hostfile ./01-hello-world
Hello! I<span class="s1">&#39;m rank 0 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">3</span> from <span class="m">8</span> running in total...
Hello! I<span class="s1">&#39;m rank 1 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">2</span> from <span class="m">8</span> running in total...
Hello! I<span class="s1">&#39;m rank 4 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">5</span> from <span class="m">8</span> running in total...
Hello! I<span class="s1">&#39;m rank 6 from 8 running in total...</span>
<span class="s1">Hello! I&#39;</span>m rank <span class="m">7</span> from <span class="m">8</span> running in total...
<span class="o">[</span>host2.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,4<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.6 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span>
<span class="o">[</span>host2.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,5<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.6 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span>
<span class="o">[</span>host2.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,6<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.6 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span>
<span class="o">[</span>host2.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,7<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.6 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span>
<span class="o">[</span>host1.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,0<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.5 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span>
<span class="o">[</span>host1.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,1<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.5 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span>
<span class="o">[</span>host1.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,2<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.5 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span>
<span class="o">[</span>host1.example.edu<span class="o">][[</span>7061,1<span class="o">]</span>,3<span class="o">][</span>btl_tcp_endpoint.c:638:mca_btl_tcp_endpoint_complete_connect<span class="o">]</span> connect<span class="o">()</span> to 128.5.5.5 failed: Operation timed out <span class="o">(</span>60<span class="o">)</span></code></pre></div>

<p>I downloaded the <a href="https://bitbucket.org/mpi4py/mpi4py/downloads">source code</a> for mpi4py, changed directories into the downloaded directory and tried running their tests:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">mpiexec --hostfile hostfile python <span class="nb">test</span>/runtests.py</code></pre></div>

<p>Running <code>runtests.py</code> when the <code>hostfile</code> contains only <code>host1.example.edu</code> or <code>host2.example.edu</code> works fine. However, when I include both hosts I end up with the same error as the <code>helloworld.py</code> example. This error doesn’t crop up with the <code>mpi4py</code> <code>helloworld</code> example, just the <code>mpi4py-examples</code> <code>helloworld</code>. The difference between the failed and successful versions being that the version that fails waits for all jobs to finish up at the end through <code>comm.Barrier()</code>.</p>

<p><a href="http://stackoverflow.com/questions/15072563/running-mpi-on-two-hosts">This article</a>, which discusses the communication was helpful — it appears the two computers, host1 and host2, can communicate with the machine I am running the commands from, but they cannot communicate with eachother.</p>

<p>I disabled the firewall through System Preferences -&gt; Security &amp; Privacy. This worked for the <code>helloworld.py</code> example, but not for <code>tests/runtests.py</code>. I should also mention that <code>host1</code> has 12 cores and <code>host2</code> has 8 cores. While testing out my hostfile I had reduced the number of “slots” on each to 4 and it worked. When I increased the number of slots on either host above 4, the connection failed error message reappeared when running <code>helloworld.py</code>.</p>

<p>It looks like part of the problem may be that <code>host1</code> and <code>host2</code> are using different SSH ports, and therefore cannot communicate between each other. I switched to using two host machines that are using the same ports for SSH, and both <code>helloworld.py</code> and <code>runtests.py</code> finished up successfully.</p>

<p>However, adding a third machine is now causing issues…</p>

<p>This turned out to be that the firewall was still on despite turning it off through the GUI in system preferences. Simply turning the firewall off through the System Preferences GUI worked on 2 of the 3 machines, so I’m not sure why it got hung up on the third. If you’re having similar problems, try taking a look at either “All Messages” or “secure.log” in the console (or /var/log/secure.log) on the mac host. If you see lines stating that the Firewall refused connection, this is your problem too. Simply restarting the system did the trick. I’ve now added several more machines and have executed <code>helloworld.py</code> and <code>tests/runtests.py</code> successfully on 96 cores!</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Matt Giguere</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Matt Giguere</li>
          <li><a href="mailto:matthew.giguere@yale.edu">matthew.giguere@yale.edu</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mattgiguere">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">mattgiguere</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/magickair">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">magickair</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Hi, I'm Matt Giguere, a graduate student searching for rocky planets and characterizing stellar activity of the stars that host them. In addition to working towards the discovery  of other rocky worlds, I am constantly working to defend my best dad  of the year title. I also enjoy learning new programming languages,  new statistical methods, and new visualization tools, and making  things in many different media.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
